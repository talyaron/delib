"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var _mithril=_interopRequireDefault(require("mithril")),_config=require("../config"),_store=_interopRequireWildcard(require("../../../data/store")),_lodash=require("lodash"),_general=require("../../general"),_set=require("../set/set");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var o=_getRequireWildcardCache();if(o&&o.has(e))return o.get(e);var t,s={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e){Object.prototype.hasOwnProperty.call(e,r)&&((t=n?Object.getOwnPropertyDescriptor(e,r):null)&&(t.get||t.set)?Object.defineProperty(s,r,t):s[r]=e[r])}return s.default=e,o&&o.set(e,s),s}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var unsubscribe={};function getUser(e){try{_config.DB.collection("users").doc(e).get().then(function(e){var o,t,s;e.exists&&(t=(o=e.data()).stopRegistrationMessages,s=o.firstTimeOnSuggestions,void 0===t&&(t=!1),_store.default.user.stopRegistrationMessages=t,void 0===s&&(_store.default.user.firstTimeOnSuggestions=!0))}).catch(function(e){console.error(e),(0,_set.sendError)(e)})}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToUserGroups(){try{if(!{}.hasOwnProperty.call(_store.default.user,"uid"))throw new Error("Cant listen to user groups, because user do not have uid");!1===_store.default.userGroupsListen&&(_store.default.userGroupsListen=!0,_config.DB.collection("users").doc(_store.default.user.uid).collection("groupsOwned").onSnapshot(function(e){setTimeout(function(){!1===_store.default.userGroups[0]&&_store.default.userGroups.splice(0,1),_mithril.default.redraw()},500),listenToGroups(e),_mithril.default.redraw()},function(e){console.error("On getUserGroups:",e.name,e.message),(0,_set.sendError)(e)}))}catch(e){console.error(e)}}function listenToRegisterdGroups(){try{!{}.hasOwnProperty.call(_store.default.user,"uid")||!1!==_store.default.registerGroupsListen||(_store.default.registerGroupsListen=!0,_config.DB.collection("users").doc(_store.default.user.uid).collection("registerGroups").onSnapshot(function(e){listenToGroups(e)},function(o){console.error("On listenToRegisterdGroups:",o.name,o.message),(0,_set.sendError)(e)}))}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToGroups(e){try{e.docChanges().forEach(function(o){var e;"added"===o.type?_store.default.userGroupsListners[o.doc.id]=listenToGroup(o.doc.id):"removed"===o.type&&(-1<(e=_store.default.userGroups.findIndex(function(e){return e.id===o.doc.id}))&&_store.default.userGroups.splice(e,1),_store.default.userGroupsListners[o.doc.id](),delete _store.default.userGroupListen[o.doc.id]),_mithril.default.redraw()})}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToGroup(s){try{return{}.hasOwnProperty.call(_store.default.userGroupsListners,s)?function(){}:(_store.default.userGroupListen[s]=!0,_config.DB.collection("groups").doc(s).onSnapshot(function(e){if(!e.exists)throw _config.DB.collection("users").doc(_store.default.user.uid).collection("registerGroups").doc(s).delete().then(function(e){return console.info(e)}),new Error("group ".concat(s," do not exists. deleteing this group from user subscription"));var o=_store.default.userGroups.findIndex(function(e){return e.id===s});!1===_store.default.userGroups[0]&&_store.default.userGroups.splice(0,1);var t=e.data();!{}.hasOwnProperty.call(t,"id")&&_config.DB.collection("groups").doc(s).update({id:s,groupId:s}).catch(function(e){console.error(e),(0,_set.sendError)(e)}),t.id=t.groupId=e.id,-1==o?_store.default.userGroups.push(t):_store.default.userGroups[o]=t,_mithril.default.redraw()},function(e){console.error("On listenToGroup:",e.name,e.message),(0,_set.sendError)(e)}))}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToGroupMembers(t){try{return _config.DB.collection("groups").doc(t).collection("members").onSnapshot(function(e){var o=[];e.forEach(function(e){o.push(e.data())}),_store.default.groupMembers[t]=o,_mithril.default.redraw()},function(e){console.error(e),(0,_set.sendError)(e)})}catch(e){return console.error(e),(0,_set.sendError)(e),function(){}}}function getQuestions(e,o,t){"on"===e?t.state.unsubscribe=_config.DB.collection("groups").doc(o).collection("questions").orderBy("time","desc").onSnapshot(function(e){e.forEach(function(e){e.data().id&&setStore(_store.default.questions,o,e.data().id,e.data())}),_mithril.default.redraw()}):t.state.unsubscribe()}function setStore(e,o,t,s){e.hasOwnProperty(o)||(e[o]={}),e[o][t]=s}function listenToGroupDetails(o,e){try{if("string"!=typeof o)throw console.info(o),new Error(" groupId is not a string");!{}.hasOwnProperty.call(_store.default.groupListen,o)&&(_store.default.groupListen[o]=!0,_config.DB.collection("groups").doc(o).onSnapshot(function(e){_store.default.groups[o]=e.data(),_mithril.default.redraw()},function(e){console.error("At listenToGroupDetails: ".concat(e.name,", ").concat(e.message)),"Missing or insufficient permissions."===e.message&&_mithril.default.route.set("/unauthorized")}))}catch(e){console.error(e)}}function getQuestionDetails(o,t,s){return _config.DB.collection("groups").doc(o).collection("questions").doc(t).onSnapshot(function(e){setStore(_store.default.questions,o,t,e.data()),s.state.title=e.data().title,s.state.description=e.data().description,s.state.creatorId=e.data().creatorId,e.data().authorization&&(s.state.authorized=e.data().authorization),listenSubQuestions(o,t,s),_mithril.default.redraw()})}function listenSubQuestions(o,e,t){try{if(!{}.hasOwnProperty.call(_store.default.subQuestionsListners,e)){if(_store.default.subQuestionsListners[e]={listen:!0},!{}.hasOwnProperty.call(t.state,"creatorId"))throw new Error("No creatorId in vnode at listenSubQuestions");t.state.creatorId,_store.default.user.uid;_config.DB.collection("groups").doc(o).collection("questions").doc(e).collection("subQuestions").onSnapshot(function(e){var t=[],s={};e.forEach(function(e){var o=e.data();o.subQuestionId=o.id=e.id,t.push(o),s[o.id]={}}),_store.default.subQuestions[o]=t,_mithril.default.redraw()})}}catch(e){console.error(e),(0,_set.sendError)(e)}}function getSubQuestion(o,t,s,e){try{return _config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(s).onSnapshot(function(e){e.exists?((0,_lodash.set)(_store.default,"subQuestions[".concat(s,"]"),e.data()),_mithril.default.redraw()):(console.error("subQuestion ".concat(o,"/").concat(t,"/").concat(s," dont exists ")),_mithril.default.route.set("question/".concat(o,"/").concat(t)))})}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToOptions(e,o,n){var t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"top";try{if({}.hasOwnProperty.call(_store.default.optionsListen,n))return function(){};_store.default.optionsListen[n]=!0;var s=_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(n).collection("options"),r="time";switch(t){case"new":r="time";break;case"top":r="consensusPrecentage";break;default:r="time"}return s.orderBy(r,"desc").limit(100).onSnapshot(function(e){console.log("listenToOptions");var s=[];e.forEach(function(e){var o,t;listenToUserLastReadOfOptionChat(e.data().optionId),null==e.data().isActive||1==e.data().isActive?((o=e.data()).id=o.optionId=e.id,o.subQuestionId=n,t=document.getElementById(o.id),_store.default.optionsLoc[o.id]=t?{offsetTop:t.offsetTop,offsetLeft:t.offsetLeft,toAnimate:!0,new:!1}:{offsetTop:0,offsetLeft:0,toAnimate:!1,new:!0},s.push(o)):console.info(e.data().id,"is not active")}),(0,_lodash.set)(_store.default,"options[".concat(n,"]"),s),_mithril.default.redraw()})}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToUserLastReadOfOptionChat(t){try{!{}.hasOwnProperty.call(_store.default.optionNumberOfMessagesRead,t)&&_config.DB.collection("users").doc(_store.default.user.uid).collection("optionsRead").doc(t).onSnapshot(function(e){var o;console.log("listenToUserLastReadOfOptionChat"),e.exists&&(o=e.data().numberOfMessages||0,_store.default.optionNumberOfMessagesRead[t]=o,_mithril.default.redraw())},function(e){console.error(e),(0,_set.sendError)(e)})}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToOption(e){try{var o=e.groupId,t=e.questionId,s=e.subQuestionId,n=e.optionId;if(void 0===o)throw new Error("missing groupId");if(void 0===t)throw new Error("missing questionId");if(void 0===s)throw new Error("missing subQuestionId");if(void 0===n)throw new Error("missing optionId");return _config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(s).collection("options").doc(n).onSnapshot(function(e){console.log("listen ot option");var o=e.data();o.optionId=e.data().optionId,(0,_lodash.set)(_store.default,"option[".concat(n,"]"),o),_mithril.default.redraw()},function(e){console.error(e),(0,_set.sendError)(e)})}catch(e){console.error(e),(0,_set.sendError)(e)}}function getOptionDetails(e,o,t,s,n){return _config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(s).onSnapshot(function(e){_store.default.optionsDetails[s]=e.data(),n.state.option.title=e.data().title,_mithril.default.redraw()})}function getOptionVote(e,o,t,s,n){try{if(void 0===e||void 0===o||void 0===t||void 0===s||void 0===n)throw new Error("One of the Ids groupId, questionId, subQuestionId, optionId, creatorId is missing",e,o,t,s,n);return _config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(s).collection("likes").doc(n).onSnapshot(function(e){e.exists?_store.default.optionsVotes[s]=e.data().like:_store.default.optionsVotes[s]=0,_mithril.default.redraw()})}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToUserVote(o){try{var e=o.attrs.ids,t=e.groupId,s=e.questionId,n=e.subQuestionId;return _config.DB.collection("groups").doc(t).collection("questions").doc(s).collection("subQuestions").doc(n).collection("votes").doc(_store.default.user.uid).onSnapshot(function(e){e.exists?o.state.optionVoted=e.data().optionVoted:o.state.optionVoted=!1,_mithril.default.redraw()},function(e){console.error(e),(0,_set.sendError)(e)})}catch(e){return console.error(e),(0,_set.sendError)(e),function(){}}}function listenToConsequences(e,o,t,s){try{!{}.hasOwnProperty.call(_store.default.consequencesListen,s)?(_store.default.consequencesListen[s]=!0,_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(s).collection("consequences").onSnapshot(function(e){var o=[];e.forEach(function(e){o.push(e.data())}),_store.default.consequences[s]=o,_mithril.default.redraw()})):console.info("Allredy listen to consequnces on option ".concat(s))}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenToTopConsequences(e){try{var o=e.groupId,t=e.questionId,s=e.subQuestionId,n=e.optionId;if(void 0===o)throw new Error("groupId is missing in listenToTopConsequences");if(void 0===t)throw new Error("questionId is missing in listenToTopConsequences");if(void 0===s)throw new Error("subQuestionId is missing in listenToTopConsequences");if(void 0===n)throw new Error("optionId is missing in listenToTopConsequences");!{}.hasOwnProperty.call(_store.default.consequencesTopListen,n)&&(_store.default.consequencesTopListen[n]=!0,_store.default.consequencesTop[n]=[],_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(s).collection("options").doc(n).collection("consequences").orderBy("totalWeightAbs","desc").limit(1).onSnapshot(function(e){e.forEach(function(e){_store.default.consequencesTop[n]=[e.data()]}),_mithril.default.redraw()}))}catch(e){console.error}}function getMyVotesOnConsequence(e,o,t,s,n){try{return _config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(s).collection("consequences").doc(n).collection("voters").doc(_store.default.user.uid).get().then(function(e){return e.data()}).catch(function(e){console.error(e),(0,_set.sendError)(e)})}catch(e){console.error(e),(0,_set.sendError)(e)}}function getSubAnswers(e,o,s,n){var t=_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(s).collection("subAnswers").orderBy("time","desc").limit(100);return unsubscribe=t.onSnapshot(function(e){var t=[];e.forEach(function(e){var o=e.data();o.id=e.id,t.push(o)}),n.state.subAnswers[s]=t,_mithril.default.redraw()})}function getMessages(e,o,t,s,n){return _config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(s).collection("messages").orderBy("time","desc").limit(20).onSnapshot(function(e){var t=[];e.size;e.forEach(function(e){var o=e.data();n.state.messagesIds.hasOwnProperty(e.id)?o.isNew=!1:o.isNew=!0,t.unshift(o),n.state.messagesIds[e.id]=!0}),n.state.messages=t,_mithril.default.redraw()})}function getSubItems(o,s,n,r){var e=_config.DB.collection("groups").doc(s).collection("questions").doc(n).collection(o);return unsubscribe=e.orderBy("totalVotes","desc").onSnapshot(function(e){e.docChanges().forEach(function(e){"added"===e.type&&(r.state.subAnswersUnsb[e.doc.id]=getSubAnswers(s,n,e.doc.id,r)),e.type});var t=[];e.forEach(function(e){var o=e.data();o.id=e.id,t.push(o)}),r.state[o]=t,_mithril.default.redraw()})}function getSubItemLikes(e,o,t,s,n,r){return _config.DB.collection("groups").doc(o).collection("questions").doc(t).collection(e).doc(s).onSnapshot(function(e){null!=e.data().totalVotes?r.state.likes=e.data().totalVotes:r.state.likes=0,_mithril.default.redraw()})}function getSubItemUserLike(e,o,t,s,n,r){return _config.DB.collection("groups").doc(o).collection("questions").doc(t).collection(e).doc(s).collection("likes").doc(n).onSnapshot(function(e){e.exists&&1==e.data().like?r.state.up=!0:r.state.up=!1,_mithril.default.redraw()})}function listenToSubscription(s){return new Promise(function(o,t){!1==={}.hasOwnProperty.call(_store.default.subscribe,s)&&_config.DB.doc("".concat(s,"/subscribers/").concat(_store.default.user.uid)).onSnapshot(function(e){(0,_lodash.set)(_store.default.subscribe,"[".concat(s,"]"),e.exists),_mithril.default.redraw(),e.exists?console.info("user is subscribed"):console.info("user is not subscribed"),o()},function(e){console.error(e),t(e)})})}function listenToFeed(){try{_config.DB.collection("users").doc(_store.default.user.uid).collection("feed").limit(20).orderBy("date","desc").onSnapshot(function(e){e.docChanges().forEach(function(e){var o;"added"===e.type&&((o=e.doc.data()).feedItemId=e.doc.id,_store.default.feed2.push(o))}),_mithril.default.redraw()})}catch(e){console.error(e)}}function listenToFeedLastEntrance(){try{_config.DB.collection("users").doc(_store.default.user.uid).collection("feedLastEntrence").doc("info").onSnapshot(function(e){var o=e.data().lastEntrance;_store.default.feed2Info={lastEntrance:o}},function(e){console.error(e)})}catch(e){console.error(e)}}function listenToChat(e){try{var o=e.groupId,t=e.questionId,s=e.subQuestionId,n=e.optionId;if(void 0===o)throw new Error("No group id in the ids");var r=(0,_general.concatenateDBPath)(o,t,s,n),i=r+"/messages",c=new Date("2020-01-01");return r in _store.default.chatLastRead?c=_store.default.chatLastRead[r]:(_store.default.chat[r]=[],_store.default.chatLastRead[r]),r in _store.default.chatMessegesNotRead||(_store.default.chatMessegesNotRead[r]=0),_config.DB.collection(i).where("createdTime",">",c).orderBy("createdTime","desc").limit(100).onSnapshot(function(e){e.docChanges().forEach(function(o){var e;"added"===o.type?(r in _store.default.chat||(_store.default.chat[r]=[]),(e=o.doc.data()).messageId=o.doc.id,_store.default.chat[r].push(e),_store.default.chatLastRead=o.doc.data().createdTime,_store.default.chatMessegesNotRead[r]++):"removed"===o.type&&(console.log("removed",o.doc.id),_store.default.chat[r]=_store.default.chat[r].filter(function(e){return e.messageId!==o.doc.id}))}),_store.default.chat[r]=_store.default.chat[r].sort(function(e,o){return e.createdTime.seconds-o.createdTime.seconds});var t="";_store.default.chat[r].map(function(e,o){e.uid===t?_store.default.chat[r][o].isSameUser=!0:(_store.default.chat[r][o].isSameUser=!1,t=e.uid)}),_mithril.default.redraw()},function(e){console.error(e),(0,_set.sendError)(e)})}catch(e){console.error(e),(0,_set.sendError)(e)}}function listenIfGetsMessages(e){try{var o,t,s=e.groupId,n=e.questionId,r=e.subQuestionId,i=e.optionId,c=(0,_general.getEntityId)(e);!{}.hasOwnProperty.call(_store.default.listenToMessages,c)&&(o=(0,_general.setBrowserUniqueId)(),t="".concat((0,_general.concatenateDBPath)(s,n,r,i),"/notifications/").concat(_store.default.user.uid),_config.DB.doc(t).onSnapshot(function(e){!e.exists||void 0===e.data()[o]?_store.default.listenToMessages[c]=!1:_store.default.listenToMessages[c]=!0,_mithril.default.redraw()},function(e){console.error(e),(0,_set.sendError)(e)}))}catch(e){console.error(e),(0,_set.sendError)(e)}}function getLastTimeEntered(e,o){try{var t=e.groupId,s=e.questionId,n=e.subQuestionId,r=e.optionId,i=e.consequenceId,c=(0,_general.concatenateDBPath)(t,s,n,r,i),u=new RegExp("/","gi");if("-groups"===(c=c.replace(u,"-")))throw o.state.unreadMessages=0,new Error("couldnt find path to spesific chat (groupId, questionId, subQuestionId, optionId, consequenceId)",t,s,n,r,i);_config.DB.collection("users").doc(_store.default.user.uid).collection("chatLastEnterence").doc(c).get().then(function(e){void 0!==e.data()?(o.state.lastTimeEntered=e.data().lastTime.seconds,_mithril.default.redraw()):o.state.lastTimeEntered=0})}catch(e){console.error(e),(0,_set.sendError)(e)}}module.exports={getUser:getUser,listenToUserGroups:listenToUserGroups,listenToRegisterdGroups:listenToRegisterdGroups,getQuestions:getQuestions,listenToGroupDetails:listenToGroupDetails,listenToGroupMembers:listenToGroupMembers,listenToGroup:listenToGroup,getQuestionDetails:getQuestionDetails,listenSubQuestions:listenSubQuestions,getSubQuestion:getSubQuestion,listenToOptions:listenToOptions,listenToOption:listenToOption,listenToConsequences:listenToConsequences,listenToTopConsequences:listenToTopConsequences,getMyVotesOnConsequence:getMyVotesOnConsequence,getOptionVote:getOptionVote,listenToUserVote:listenToUserVote,getSubItems:getSubItems,getSubItemLikes:getSubItemLikes,getSubItemUserLike:getSubItemUserLike,getSubAnswers:getSubAnswers,getOptionDetails:getOptionDetails,getMessages:getMessages,listenToFeed:listenToFeed,listenToChat:listenToChat,listenToFeedLastEntrance:listenToFeedLastEntrance,listenToSubscription:listenToSubscription,listenIfGetsMessages:listenIfGetsMessages,getLastTimeEntered:getLastTimeEntered};