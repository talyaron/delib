"use strict";var _mithril=_interopRequireDefault(require("mithril")),_lodash2=require("lodash"),_config=require("../config"),_store2=_interopRequireDefault(require("../../../data/store")),_general2=require("../../general"),_setChats=require("./setChats");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}function createGroup(e){try{var o=e.creatorId,t=e.title,n=e.description,c=e.callForAction,r=e.language;console.log(o,t,n,c,r);var s=(0,_general2.uniqueId)();_config.DB.collection("groups").doc(s).set({title:t,description:n,creatorId:o,time:(new Date).getTime(),groupId:s,id:s,groupColor:(0,_general2.getRandomColor)(),callForAction:c,language:r}).then(function(){_config.DB.collection("users").doc(_store2.default.user.uid).collection("groupsOwned").doc(s).set({id:s,date:(new Date).getTime()}).then(function(){console.info("added the group to the groups the user owns")}).catch(function(e){console.error(e)}),(0,_setChats.subscribeUser)({groupId:s,subscribe:!1}),_mithril.default.route.set("/group/".concat(s))}).catch(function(e){console.error("Error adding document: ",e)})}catch(e){console.error(e)}}function updateGroup(e){_config.DB.collection("groups").doc(e.attrs.id).update({title:e.state.title,description:e.state.description,callForAction:e.state.callForAction}).then(function(){_mithril.default.route.set("/group/".concat(e.attrs.id))}).catch(function(e){console.error(e)})}function registerGroup(c){try{var r,s=(0,_lodash2.get)(_store2.default.user,".groupsUserTryToRegister[".concat(c,"]"),!1);s||((0,_lodash2.set)(_store2.default.user,".groupsUserTryToRegister[".concat(c,"]"),!0),r=setInterval(function(){if({}.hasOwnProperty.call(_store2.default.user,"uid"))if(clearInterval(r),s)console.info("user is already registered to",c);else{_store2.default.groupsRegistered[c]=!0,_config.DB.collection("users").doc(_store2.default.user.uid).collection("registerGroups").doc(c).set({register:!0}).then(function(){console.info("user registerd to group",c)}).catch(function(e){console.error(e)});var e=_store2.default.user,o={displayName:e.displayName,email:e.email,uid:e.uid,name:e.name,photoURL:e.photoURL,phoneNumber:e.phoneNumber,isAnonymous:e.isAnonymous},t={};for(var n in o)null!=o[n]&&(t[n]=o[n]);_config.DB.collection("groups").doc(c).collection("members").doc(_store2.default.user.uid).set(t,{merge:!0}).then(function(){console.info("user is a member of group",c)}).catch(function(e){console.error(e)})}},1e3))}catch(e){console.error(e)}}function createQuestion(e,o,t,n){var c=(0,_general2.uniqueId)();_config.DB.collection("groups").doc(e).collection("questions").doc(c).set({title:t,description:n,time:(new Date).getTime(),creatorId:o,questionId:c,id:c}).catch(function(e){console.error("Error adding document: ",e)})}function updateQuestion(e,o,t,n,c){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).update({title:t,description:n,authorization:c}).then(function(e){console.info("writen succesufuly")}).catch(function(e){console.error("Error adding document: ",e)})}catch(e){console.error(e)}}function createSubQuestion(n,c,r,s){try{return new Promise(function(e,o){var t=(0,_general2.uniqueId)();_config.DB.collection("groups").doc(n).collection("questions").doc(c).collection("subQuestions").doc(t).set({title:r,order:s,creator:_store2.default.user.uid,orderBy:"top",subQuestionId:t,id:t}).then(function(){e(t)}).catch(function(e){console.error("Error adding document: ",e),o(void 0)})})}catch(e){console.error(e),reject(void 0)}}function updateSubQuestion(e,o,t,n){_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({title:n})}function updateSubQuestionProcess(e,o,t,n){_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({processType:n})}function updateSubQuestionOrderBy(e,o,t,n){_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({orderBy:n})}function setSubQuestion(g,h){try{return new Promise(function(e,o){var t,n=h.title,c=h.processType,r=h.orderBy,s=h.userHaveNavigation,i=h.showSubQuestion,u=h.numberOfSubquestions,d=h.proAgainstType,a=g.groupId,l=g.questionId,f=g.subQuestionId,p=_config.DB.collection("groups").doc(a).collection("questions").doc(l).collection("subQuestions");void 0===f?(t=(0,_general2.uniqueId)(),p.doc(t).set({title:n,processType:c,orderBy:r,groupId:a,questionId:l,subQuestionId:t,userHaveNavigation:s,showSubQuestion:i,order:u,proAgainstType:d,creator:_store2.default.user.uid}).then(function(){console.info("saved subQuestion ".concat(t," to DB")),e(t)}).catch(function(e){console.error(e),o(void 0)})):p.doc(f).update({title:n,processType:c,orderBy:r,groupId:a,questionId:l,subQuestionId:f,userHaveNavigation:s,showSubQuestion:i,proAgainstType:d}).then(function(){console.info("updated subQuestion ".concat(f," to DB")),e(f)}).catch(function(e){console.error(e),o(void 0)})})}catch(e){console.error(e)}}function deleteSubQuestion(e,o,t){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({showSubQuestion:"deleted"}).then(function(){console.info("SubQuestion was deleted (and styed in db as subQuestion",t,")")}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function updateDoesUserHaveNavigation(e,o,t,n){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({userHaveNavigation:n}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function updateSubQuestionsOrder(e,o,t){_config.DB.collection("groups").doc(e).collection("questions").doc(o).update({subQuestions:{order:t}}).then(function(e){console.info("writen succesufuly")}).catch(function(e){console.error("Error adding document: ",e)})}function setSubQuestionsOrder(e,o,t,n){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({order:n}).then(function(e){console.info("writen to ".concat(t," succesufuly"))}).catch(function(e){console.error("Error adding document: ",e)})}catch(e){console.error(e)}}function createOption(e,o,t,n,c,r,s,i,u){var d=9<arguments.length&&void 0!==arguments[9]&&arguments[9],a=(0,_general2.uniqueId)();try{return _config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(a).set({groupId:e,questionId:o,subQuestionId:t,optionId:a,id:a,creatorId:c,type:n,title:r,description:s,creatorName:i,subQuestionTitle:u,time:firebase.firestore.FieldValue.serverTimestamp(),consensusPrecentage:0,isActive:!0,isVote:d}).catch(function(e){console.error("Error adding document: ",e)}),a}catch(e){return console.error(e),!1}}function voteOption(e,o){try{var t=e.groupId,n=e.questionId,c=e.subQuestionId,r=e.optionId,s=o.addVote,i=_config.DB.collection("groups").doc(t).collection("questions").doc(n).collection("subQuestions").doc(c).collection("votes").doc(_store2.default.user.uid),u={optionVoted:r,voter:{voterId:_store2.default.user.uid,name:_store2.default.user.name,photoURL:_store2.default.user.photoURL||""}};s?i.update(u).then(function(){console.info("Option ".concat(r," was voted for"))}).catch(function(e){new RegExp("No document to update").test(e.message)?i.set(u).then(function(){console.log("A vote to option ".concat(r," was added"))}).catch(function(e){console.error(e)}):console.error(e)}):i.delete().then(function(){console.info("Option ".concat(r," was deleted"))}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function createConsequence(e,o,t,n,c,r,s,i,u){try{var d=(0,_general2.uniqueId)();_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(n).collection("consequences").doc(d).set({groupId:e,questionId:o,subQuestionId:t,optionId:n,consequenceId:d,creatorId:c,title:r,description:s,creatorName:u,time:firebase.firestore.FieldValue.serverTimestamp(),consensusPrecentage:0,isActive:!0}).then(function(){voteConsequence({groupId:e,questionId:o,subQuestionId:t,optionId:n,consequenceId:d},1,i),console.info("consequence",d,"was saved")}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function voteConsequence(e,o,t){try{var n=e.groupId,c=e.questionId,r=e.subQuestionId,s=e.optionId,i=e.consequenceId;if(void 0===o)throw new Error("No truthiness in voteConsequence",o);if(void 0===t)throw new Error("No evaluation in voteConsequence",t);if(isNaN(o))throw new Error("truthiness is not a number",value);if(o<0||1<o)throw new Error("truthiness is out of range (0 --\x3e1):",o);if(isNaN(t))throw new Error("evaluation is not a number",value);if(t<-1||1<t)throw new Error("evaluation is out of range (-1 --\x3e 1):",t);var u=_store2.default.user.uid;_config.DB.collection("groups").doc(n).collection("questions").doc(c).collection("subQuestions").doc(r).collection("options").doc(s).collection("consequences").doc(i).collection("voters").doc(u).set({truthiness:o,evaluation:t,userId:u,time:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}).then(function(){console.info("consequence",i,"was voted")}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function setOptionActive(e,o,t,n,c){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(n).update({isActive:c})}catch(e){console.error(e)}}function updateOptionDescription(e,o){try{var t=e.groupId,n=e.questionId,c=e.subQuestionId,r=e.optionId;_config.DB.collection("groups").doc(t).collection("questions").doc(n).collection("subQuestions").doc(c).collection("options").doc(r).update({description:o}).then(function(){console.info("a description was updated on option ".concat(r))}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function setLike(e,o,t,n,c,r){try{if(void 0===e||void 0===o||void 0===t||void 0===n||void 0===c)throw new Error("One of the Ids groupId, questionId, subQuestionId, optionId, creatorId is missing",e,o,t,n,c);_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(n).collection("likes").doc(c).set({like:r}).catch(function(e){console.error("Error adding document: ",e)})}catch(e){console.error(e)}}function setMessage(o,t,n,c,e,r,s,i,u,d){_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(n).collection("options").doc(c).collection("messages").add({creatorId:e,creatorName:r,time:firebase.firestore.FieldValue.serverTimestamp(),timeSeconds:(new Date).getTime(),message:s,type:"messages",groupName:i,questionName:u,optionName:d}).then(function(e){_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(n).collection("options").doc(c).update({lastMessage:firebase.firestore.FieldValue.serverTimestamp()}).catch(function(e){console.error(e)})}).catch(function(e){console.error("Error:",e)})}function createSubItem(e,o,t,n,c,r,s){var i=_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection(e),u={groupId:o,questionId:t,creatorId:n,title:r,description:s,author:c,time:firebase.firestore.FieldValue.serverTimestamp(),consensusPrecentage:0,roles:{},totalVotes:0};u.roles[n]="owner",i.add(u).then(function(e){}).catch(function(e){console.error("Error adding document: ",e)})}function updateSubItem(e,o,t,n,c,r){var s=_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection(e).doc(n),i={title:c,description:r,time:firebase.firestore.FieldValue.serverTimestamp()};s.update(i).then(function(e){}).catch(function(e){console.error("Error updating document: ",e)})}function setLikeToSubItem(e,o,t,n,c,r){console.log(e,o,t,n);var s=_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection(e).doc(n).collection("likes").doc(c);r?s.set({like:1}):s.set({like:0})}function setSubAnswer(e,o,t,n,c,r){var s;_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("subAnswers").add((_defineProperty(s={groupId:e,questionId:o,subQuestionId:t,creatorId:n,author:c},"creatorId",n),_defineProperty(s,"time",firebase.firestore.FieldValue.serverTimestamp()),_defineProperty(s,"message",r),s)).then(function(e){}).catch(function(e){console.error("Error adding document: ",e)})}function addToFeed(e,o,t,n){"add"==e?_config.DB.collection("users").doc(_store2.default.user.uid).collection("feeds").doc(t).set({path:t,time:(new Date).getTime(),type:n,refString:t}).then(function(){_store2.default.subscribed[t]=!0,console.dir(_store2.default.subscribed)}).catch(function(e){console.error("Error writing document: ",e)}):_config.DB.collection("users").doc(_store2.default.user.uid).collection("feeds").doc(t).delete().then(function(){delete _store2.default.subscribed[t]}).catch(function(e){console.error("Error removing document: ",e)})}function setToFeedLastEntrance(){try{_config.DB.collection("users").doc(_store2.default.user.uid).collection("feedLastEntrence").doc("info").set({lastEntrance:(new Date).getTime()}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function updateOption(e){var o=e.attrs.ids,t=o.groupId,n=o.questionId,c=o.subQuestionId,r=o.optionId;try{var s=e.state.isNamed?e.state.creatorName:"אנונימי/ת";_config.DB.collection("groups").doc(t).collection("questions").doc(n).collection("subQuestions").doc(c).collection("options").doc(r).update({creatorUid:_store2.default.user.uid,creatorName:s,title:e.state.title,description:e.state.description}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function setChatLastEntrance(e){try{var o=e.groupId,t=e.questionId,n=e.subQuestionId,c=e.optionId,r=e.consequenceId,s=(0,_general2.concatenateDBPath)(o,t,n,c,r),i=new RegExp("/","gi");if("-groups"===(s=s.replace(i,"-")))throw new Error("couldnt find path to spesific chat (groupId, questionId, subQuestionId, optionId, consequenceId)",o,t,n,c,r);_config.DB.collection("users").doc(_store2.default.user.uid).collection("chatLastEnterence").doc(s).set({lastTime:firebase.firestore.FieldValue.serverTimestamp()}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function setNotifications(e,o){try{var t=e.groupId,n=e.questionId,c=e.subQuestionId,r=e.optionId,s="".concat((0,_general2.concatenateDBPath)(t,n,c,r),"/notifications/").concat(_store2.default.user.uid);o?_config.DB.doc(s).set({username:_store2.default.user.name,email:_store2.default.user.email||null}).catch(function(e){console.error(e)}):_config.DB.doc(s).delete().catch(function(e){console.error(e)})}catch(e){console.error(e)}}function setNumberOfMessagesMark(e){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;try{var t=e.optionId;if(void 0===t)throw new Error("option doesnt have optionId");_config.DB.collection("users").doc(_store2.default.user.uid).collection("optionsRead").doc(t).set({numberOfMessages:o}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function dontShowPopAgain(){try{_config.DB.collection("users").doc(_store2.default.user.uid).update({stopRegistrationMessages:!0}).then(function(){return console.info("user will not recive pop messages again")}).catch(function(e){return console.error(e)})}catch(e){console.error(e)}}function markUserSeenSuggestionsWizard(){try{_config.DB.collection("users").doc(_store2.default.user.uid).update({firstTimeOnSuggestions:!1}).then(function(){console.info("user seen wizared")}).catch(function(e){return console.error(e)})}catch(e){console.error(e)}}function handleSubscription(e){try{var o=e.attrs,t=o.groupId,n=o.questionId,c=o.subQuestionId,r=o.optionId,s=(0,_general.concatenateDBPath)(t,n,c,r);(0,_setChats.subscribeUser)({vnode:e,subscribe:e.state.subscribed}),0==e.state.subscribed?(e.state.subscribed=!0,(0,_lodash.set)(_store.default.subscribe,"[".concat(s,"]"),!0)):(e.state.subscribed=!1,_lodash.set)(_store.default.subscribe,"[".concat(s,"]"),!1)}catch(e){console.error(e)}}module.exports={updateOption:updateOption,addToFeed:addToFeed,createGroup:createGroup,updateGroup:updateGroup,registerGroup:registerGroup,createQuestion:createQuestion,updateQuestion:updateQuestion,createSubQuestion:createSubQuestion,updateSubQuestion:updateSubQuestion,setSubQuestion:setSubQuestion,deleteSubQuestion:deleteSubQuestion,setSubQuestionsOrder:setSubQuestionsOrder,createOption:createOption,voteOption:voteOption,updateOptionDescription:updateOptionDescription,createConsequence:createConsequence,voteConsequence:voteConsequence,setOptionActive:setOptionActive,createSubItem:createSubItem,updateSubItem:updateSubItem,setLikeToSubItem:setLikeToSubItem,setLike:setLike,setMessage:setMessage,setSubAnswer:setSubAnswer,updateSubQuestionProcess:updateSubQuestionProcess,updateSubQuestionOrderBy:updateSubQuestionOrderBy,updateDoesUserHaveNavigation:updateDoesUserHaveNavigation,setChatLastEntrance:setChatLastEntrance,setToFeedLastEntrance:setToFeedLastEntrance,setNotifications:setNotifications,setNumberOfMessagesMark:setNumberOfMessagesMark,dontShowPopAgain:dontShowPopAgain,markUserSeenSuggestionsWizard:markUserSeenSuggestionsWizard,handleSubscription:handleSubscription};