"use strict";var _mithril=_interopRequireDefault(require("mithril")),_lodash=require("lodash"),_config=require("../config"),_store=_interopRequireDefault(require("../../../data/store")),_general=require("../../general"),_setChats=require("./setChats");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}function createGroup(o){try{var t=o.creatorId,r=o.title,n=o.description,s=o.callForAction,c=o.language,i=(0,_general.uniqueId)();_config.DB.collection("groups").doc(i).set({title:r,description:n,creatorId:t,time:(new Date).getTime(),groupId:i,id:i,groupColor:(0,_general.getRandomColor)(),callForAction:s,language:c}).then(function(){_config.DB.collection("users").doc(_store.default.user.uid).collection("groupsOwned").doc(i).set({id:i,date:(new Date).getTime()}).then(function(){console.info("added the group to the groups the user owns")}).catch(function(e){console.error(e),sendError(e)}),(0,_setChats.subscribeUser)({groupId:i,subscribe:!1}),_mithril.default.route.set("/group/".concat(i))}).catch(function(o){console.error("Error adding document: ",o),sendError(e)})}catch(e){console.error(e),sendError(e)}}function updateGroup(e){try{_config.DB.collection("groups").doc(e.attrs.id).update({title:e.state.title,description:e.state.description,callForAction:e.state.callForAction||""}).then(function(){_mithril.default.route.set("/group/".concat(e.attrs.id))}).catch(function(e){throw e})}catch(e){console.error(e),sendError(e)}}function registerGroup(n){try{var s,c=(0,_lodash.get)(_store.default.user,".groupsUserTryToRegister[".concat(n,"]"),!1);c||((0,_lodash.set)(_store.default.user,".groupsUserTryToRegister[".concat(n,"]"),!0),s=setInterval(function(){if({}.hasOwnProperty.call(_store.default.user,"uid"))if(clearInterval(s),c)console.info("user is already registered to",n);else{_store.default.groupsRegistered[n]=!0,_config.DB.collection("users").doc(_store.default.user.uid).collection("registerGroups").doc(n).set({register:!0}).then(function(){console.info("user registerd to group",n)}).catch(function(e){console.error(e),sendError(e)});var e=_store.default.user,o={displayName:e.displayName,email:e.email,uid:e.uid,name:e.name,photoURL:e.photoURL,phoneNumber:e.phoneNumber,isAnonymous:e.isAnonymous},t={};for(var r in o)null!=o[r]&&(t[r]=o[r]);_config.DB.collection("groups").doc(n).collection("members").doc(_store.default.user.uid).set(t,{merge:!0}).then(function(){console.info("user is a member of group",n)}).catch(function(e){console.error(e),sendError(e)})}},1e3))}catch(e){console.error(e),sendError(e)}}function createSubQuestion(n,s,c,i){try{return new Promise(function(o,t){var r=(0,_general.uniqueId)();_config.DB.collection("groups").doc(n).collection("questions").doc(s).collection("subQuestions").doc(r).set({title:c,order:i,creator:_store.default.user.uid,orderBy:"top",subQuestionId:r,id:r}).then(function(){o(r)}).catch(function(o){console.error("Error adding document: ",o),sendError(e),t(void 0)})})}catch(e){console.error(e),sendError(e),reject(void 0)}}function updateSubQuestion(e,o,t,r){_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({title:r})}function updateSubQuestionProcess(e,o,t,r){_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({processType:r})}function updateSubQuestionOrderBy(e,o,t,r){_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({orderBy:r})}function setSubQuestion(h,b){return new Promise(function(e,o){try{var t,r=b.title,n=b.processType,s=b.orderBy,c=b.userHaveNavigation,i=b.showSubQuestion,u=b.numberOfSubquestions,d=b.proAgainstType,a=(a=b.cutoff)||!1,l=h.groupId,f=h.questionId,p=h.subQuestionId,g=_config.DB.collection("groups").doc(l).collection("questions").doc(f).collection("subQuestions");void 0===p?(t=(0,_general.uniqueId)(),g.doc(t).set({title:r,processType:n,orderBy:s,groupId:l,questionId:f,subQuestionId:t,userHaveNavigation:c,showSubQuestion:i,order:u,proAgainstType:d,creator:_store.default.user.uid,cutoff:a}).then(function(){console.info("saved subQuestion ".concat(t," to DB")),e(t)}).catch(function(e){console.error(e),sendError(e),o(void 0)})):g.doc(p).update({title:r,processType:n,orderBy:s,groupId:l,questionId:f,subQuestionId:p,userHaveNavigation:c,showSubQuestion:i,proAgainstType:d,cutoff:a}).then(function(){console.info("updated subQuestion ".concat(p," to DB")),e(p)}).catch(function(e){console.error(e),sendError(e),o(void 0)})}catch(e){console.error(e),sendError(e),o(void 0)}})}function deleteSubQuestion(e,o,t){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({showSubQuestion:"deleted"}).then(function(){console.info("SubQuestion was deleted (and styed in db as subQuestion",t,")")}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function updateDoesUserHaveNavigation(e,o,t,r){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).update({userHaveNavigation:r}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function updateSubQuestionsOrder(o,t,r){_config.DB.collection("groups").doc(o).collection("questions").doc(t).update({subQuestions:{order:r}}).then(function(e){console.info("writen succesufuly")}).catch(function(o){console.error("Error adding document: ",o),sendError(e)})}function setSubQuestionsOrder(o,t,r,n){try{_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(r).update({order:n}).then(function(e){console.info("writen to ".concat(r," succesufuly"))}).catch(function(o){console.error("Error adding document: ",o),sendError(e)})}catch(e){console.error(e),sendError(e)}}function createOption(o,t,r,n,s,c,i,u,d){var a=9<arguments.length&&void 0!==arguments[9]&&arguments[9],l=(0,_general.uniqueId)();try{return _config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(r).collection("options").doc(l).set({groupId:o,questionId:t,subQuestionId:r,optionId:l,id:l,creatorId:s,type:n,title:c,description:i,creatorName:u,subQuestionTitle:d,time:firebase.firestore.FieldValue.serverTimestamp(),consensusPrecentage:0,isActive:!0,isVote:a}).catch(function(o){console.error("Error adding document: ",o),sendError(e)}),l}catch(e){return console.error(e),sendError(e),!1}}function voteOption(e,o){try{var t=e.groupId,r=e.questionId,n=e.subQuestionId,s=e.optionId,c=o.addVote,i=_config.DB.collection("groups").doc(t).collection("questions").doc(r).collection("subQuestions").doc(n).collection("votes").doc(_store.default.user.uid),u={optionVoted:s,voter:{voterId:_store.default.user.uid,name:_store.default.user.name,photoURL:_store.default.user.photoURL||""}};c?i.set(u,{margin:!0}).then(function(){console.info("Option ".concat(s," was voted for"))}).catch(function(e){new RegExp("No document to update").test(e.message)?i.set(u).then(function(){console.info("A vote to option ".concat(s," was added"))}).catch(function(e){console.error(e)}):console.error(e)}):i.delete().then(function(){console.info("Option ".concat(s," was deleted"))}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function createConsequence(e,o,t,r,n,s,c,i,u){try{var d=(0,_general.uniqueId)();_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(r).collection("consequences").doc(d).set({groupId:e,questionId:o,subQuestionId:t,optionId:r,consequenceId:d,creatorId:n,title:s,description:c,creatorName:u,time:firebase.firestore.FieldValue.serverTimestamp(),consensusPrecentage:0,isActive:!0}).then(function(){voteConsequence({groupId:e,questionId:o,subQuestionId:t,optionId:r,consequenceId:d},1,i),console.info("consequence",d,"was saved")}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function voteConsequence(e,o,t){try{var r=e.groupId,n=e.questionId,s=e.subQuestionId,c=e.optionId,i=e.consequenceId;if(void 0===o)throw new Error("No truthiness in voteConsequence",o);if(void 0===t)throw new Error("No evaluation in voteConsequence",t);if(isNaN(o))throw new Error("truthiness is not a number",value);if(o<0||1<o)throw new Error("truthiness is out of range (0 --\x3e1):",o);if(isNaN(t))throw new Error("evaluation is not a number",value);if(t<-1||1<t)throw new Error("evaluation is out of range (-1 --\x3e 1):",t);var u=_store.default.user.uid;_config.DB.collection("groups").doc(r).collection("questions").doc(n).collection("subQuestions").doc(s).collection("options").doc(c).collection("consequences").doc(i).collection("voters").doc(u).set({truthiness:o,evaluation:t,userId:u,time:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}).then(function(){console.info("consequence",i,"was voted")}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function setOptionActive(e,o,t,r,n){try{_config.DB.collection("groups").doc(e).collection("questions").doc(o).collection("subQuestions").doc(t).collection("options").doc(r).update({isActive:n})}catch(e){console.error(e)}}function updateOptionDescription(e,o){try{var t=e.groupId,r=e.questionId,n=e.subQuestionId,s=e.optionId;_config.DB.collection("groups").doc(t).collection("questions").doc(r).collection("subQuestions").doc(n).collection("options").doc(s).update({description:o}).then(function(){console.info("a description was updated on option ".concat(s))}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function setLike(o,t,r,n,s,c){try{if(void 0===o||void 0===t||void 0===r||void 0===n||void 0===s)throw new Error("One of the Ids groupId, questionId, subQuestionId, optionId, creatorId is missing",o,t,r,n,s);_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(r).collection("options").doc(n).collection("likes").doc(s).set({like:c}).catch(function(o){console.error("Error adding document: ",o),sendError(e)})}catch(e){console.error(e),sendError(e)}}function setMessage(o,t,r,n,s,c,i,u,d,a){_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(r).collection("options").doc(n).collection("messages").add({creatorId:s,creatorName:c,time:firebase.firestore.FieldValue.serverTimestamp(),timeSeconds:(new Date).getTime(),message:i,type:"messages",groupName:u,questionName:d,optionName:a}).then(function(e){_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(r).collection("options").doc(n).update({lastMessage:firebase.firestore.FieldValue.serverTimestamp()}).catch(function(e){console.error(e),sendError(e)})}).catch(function(o){console.error("Error:",o),sendError(e)})}function createSubItem(o,t,r,n,s,c,i){var u=_config.DB.collection("groups").doc(t).collection("questions").doc(r).collection(o),d={groupId:t,questionId:r,creatorId:n,title:c,description:i,author:s,time:firebase.firestore.FieldValue.serverTimestamp(),consensusPrecentage:0,roles:{},totalVotes:0};d.roles[n]="owner",u.add(d).then(function(e){}).catch(function(o){console.error("Error adding document: ",o),sendError(e)})}function updateSubItem(o,t,r,n,s,c){var i=_config.DB.collection("groups").doc(t).collection("questions").doc(r).collection(o).doc(n),u={title:s,description:c,time:firebase.firestore.FieldValue.serverTimestamp()};i.update(u).then(function(e){}).catch(function(o){console.error("Error updating document: ",o),sendError(e)})}function setLikeToSubItem(e,o,t,r,n,s){var c=_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection(e).doc(r).collection("likes").doc(n);s?c.set({like:1}):c.set({like:0})}function setSubAnswer(o,t,r,n,s,c){var i;_config.DB.collection("groups").doc(o).collection("questions").doc(t).collection("subQuestions").doc(r).collection("subAnswers").add((_defineProperty(i={groupId:o,questionId:t,subQuestionId:r,creatorId:n,author:s},"creatorId",n),_defineProperty(i,"time",firebase.firestore.FieldValue.serverTimestamp()),_defineProperty(i,"message",c),i)).then(function(e){}).catch(function(o){console.error("Error adding document: ",o),sendError(e)})}function addToFeed(o,t,r,n){"add"==o?_config.DB.collection("users").doc(_store.default.user.uid).collection("feeds").doc(r).set({path:r,time:(new Date).getTime(),type:n,refString:r}).then(function(){_store.default.subscribed[r]=!0,console.dir(_store.default.subscribed)}).catch(function(o){console.error("Error writing document: ",o),sendError(e)}):_config.DB.collection("users").doc(_store.default.user.uid).collection("feeds").doc(r).delete().then(function(){delete _store.default.subscribed[r]}).catch(function(o){console.error("Error removing document: ",o),sendError(e)})}function setToFeedLastEntrance(){try{_config.DB.collection("users").doc(_store.default.user.uid).collection("feedLastEntrence").doc("info").set({lastEntrance:(new Date).getTime()}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}function updateOption(e){var o=e.attrs.ids,t=o.groupId,r=o.questionId,n=o.subQuestionId,s=o.optionId;try{var c=e.state.isNamed?e.state.creatorName:"אנונימי/ת";_config.DB.collection("groups").doc(t).collection("questions").doc(r).collection("subQuestions").doc(n).collection("options").doc(s).update({creatorUid:_store.default.user.uid,creatorName:c,title:e.state.title,description:e.state.description}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function setNotifications(e,o){try{var t=e.groupId,r=e.questionId,n=e.subQuestionId,s=e.optionId,c="".concat((0,_general.concatenateDBPath)(t,r,n,s),"/notifications/").concat(_store.default.user.uid);o?_config.DB.doc(c).set({username:_store.default.user.name,email:_store.default.user.email||null}).catch(function(e){console.error(e),sendError(e)}):_config.DB.doc(c).delete().catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function setNumberOfMessagesMark(e){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;try{var t=e.optionId;if(void 0===t)throw new Error("option doesnt have optionId");_config.DB.collection("users").doc(_store.default.user.uid).collection("optionsRead").doc(t).set({numberOfMessages:o}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function dontShowPopAgain(){try{_config.DB.collection("users").doc(_store.default.user.uid).update({stopRegistrationMessages:!0}).then(function(){return console.info("user will not recive pop messages again")}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function markUserSeenSuggestionsWizard(){try{_config.DB.collection("users").doc(_store.default.user.uid).update({firstTimeOnSuggestions:!1}).then(function(){console.info("user seen wizared")}).catch(function(e){console.error(e),sendError(e)})}catch(e){console.error(e),sendError(e)}}function handleSubscription(e){try{var o=e.attrs,t=o.groupId,r=o.questionId,n=o.subQuestionId,s=o.optionId,c=(0,_general.concatenateDBPath)(t,r,n,s);(0,_setChats.subscribeUser)({groupId:t,questionId:r,subQuestionId:n,optionId:s,subscribe:e.state.subscribed}),0==e.state.subscribed?(e.state.subscribed=!0,(0,_lodash.set)(_store.default.subscribe,"[".concat(c,"]"),!0)):(e.state.subscribed=!1,_lodash.set)(_store.default.subscribe,"[".concat(c,"]"),!1)}catch(e){console.error(e),sendError(e)}}function sendError(e){try{_config.DB.collection("errors").add({message:e.message,user:_store.default.user,date:firebase.firestore.FieldValue.serverTimestamp()}).catch(function(e){console.error(e)})}catch(e){console.error(e)}}module.exports={updateOption:updateOption,addToFeed:addToFeed,createGroup:createGroup,updateGroup:updateGroup,registerGroup:registerGroup,createSubQuestion:createSubQuestion,updateSubQuestion:updateSubQuestion,setSubQuestion:setSubQuestion,deleteSubQuestion:deleteSubQuestion,setSubQuestionsOrder:setSubQuestionsOrder,createOption:createOption,voteOption:voteOption,updateOptionDescription:updateOptionDescription,createConsequence:createConsequence,voteConsequence:voteConsequence,setOptionActive:setOptionActive,createSubItem:createSubItem,updateSubItem:updateSubItem,setLikeToSubItem:setLikeToSubItem,setLike:setLike,setMessage:setMessage,setSubAnswer:setSubAnswer,updateSubQuestionProcess:updateSubQuestionProcess,updateSubQuestionOrderBy:updateSubQuestionOrderBy,updateDoesUserHaveNavigation:updateDoesUserHaveNavigation,setToFeedLastEntrance:setToFeedLastEntrance,setNotifications:setNotifications,setNumberOfMessagesMark:setNumberOfMessagesMark,dontShowPopAgain:dontShowPopAgain,markUserSeenSuggestionsWizard:markUserSeenSuggestionsWizard,handleSubscription:handleSubscription,sendError:sendError};